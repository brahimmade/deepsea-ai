
# Training

## Getting your training data ready

Your data needs to be organized into separate folders for training/validation/test.
This input required for the popular Ultralytics YOLOv5 model.

Assuming that you have downloaded your images and YOLO Darknet TXT files into separate images/ and labels/ folders,
use the **split** command to simplify this step

```
├── data
│   │   ├── images
│   │   │   └── image1.jpg
│   │   │   └── image2.jpg
│   │   ├── labels
│   │   │   └── image1.txt
│   │   │   └── image2.txt 
```  

Split the data with the **split** command
```
deepsea-ai split -i data -o split
```
```
Autosplitting images from data
100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 160/160 [00:00<00:00, 28060.24it/s]
Splitting autosplit_train.txt
132it [00:00, 428.74it/s]
Splitting autosplit_val.txt
19it [00:00, 259.01it/s]
Splitting autosplit_test.txt
9it [00:00, 295.15it/s]
Creating split/labels.tar.gz...
Creating split/images.tar.gz...
Done
```

You should now have compressed labels and images that have been split into training/validation/test sets respectively by 85%/15%/5%. 
These compressed files are used in the **train** command
```
split
├── images.tar.gz
└── labels.tar.gz
```


Lastly, a plain text file is needed to map the numeric class IDs in the labels/ to names. That is passed in with the **--label-map** option.

## Why do I need a label-map file?

YOLOv5 uses an annotation format similar to YOLO Darknet TXT but with the addition of a YAML file
which contains the model configuration and class values. The YAML file is autogenerated in a *deepsea-ai* processing job,
with the help of this simple .txt file.  **Important** the class names should be listed in the same sorted order of the 
class labels in the YOLO Darknet TXT files. Pay attention to your order as it is a common mistake. 


## Training a YOLOv5 model

If your training has been scaled to 640x640, use yolov5s or yolov5x, e.g.

```
deepsea-ai train --model yolov5x --instance-type ml.p2.xlarge \
--labels split/labels.tar.gz \
--images split/images.tar.gz \
--label-map names.txt \
--input-s3 s3://benthic-dive-training/ \
--output-s3 s3://benthic-dive-checkpoints/ \
--epochs 1
```

## YOLOv5 Models and Instance Types

SageMaker has a number of instances available. The instance type chosen depends on the model and how larger your batch size is, e.g.
for a batch size of 2:

| Model (the --model option)  | Training Image Size (pixels) | Recommended Instance Type (instance-type option)    | COCO mAP<sup>val<br>0.5:0.95 |
|---|------------------------------|-----------------------------------------------------|------------------------------|
|yolov5s| 640x640                      | ml.p3.2xlarge                                       | 36.7                         |
|yolov5x| 640x640                      | ml.p3.2xlarge                                       | **50.4**                     |
|yolov5s6| 1280x1280                    | ml.p3.8xlarge, ml.p3.16xlarge or ml.p4d.24xlarge    | 43.3                         |
|yolov5x6| 1280x1280                    | ml.p3.16xlarge, ml.p3dn.24xlarge or ml.p4d.24xlarge | **54.4**                     |

Larger batch sizes require larger instance type, e.g. the yolov5x with a batch size=8 would require ml.p3.16xlarge or ml.p4d.24xlarge (recommended)
 

## Resuming from a previously trained YOLOv5 model

To resume from a previously trained model, pass in the checkpoint bucket from the previous training run. For example,
to resume training for another 4 epochs

```
deepsea-ai train --model yolov5x --instance-type ml.p2.xlarge \
--labels split/labels.tar.gz \
--images split/images.tar.gz \
--label-map names.txt \
--input-s3 s3://benthic-dive-training/20220901T221143Z/checkpoints/ \
--output-s3 s3://benthic-dive-checkpoints/ \
--resume True --epochs 4
```